name: Code Quality & Coverage

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  quality:
    name: Code Quality Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Bun runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Run full test suite with reporting
        id: tests
        run: |
          echo "Running comprehensive test suite..."
          bun test.ts 2>&1 | tee test-results.log
          TEST_EXIT=$?
          
          # Extract summary from output
          SUMMARY=$(grep -A 20 "Test Summary" test-results.log || echo "")
          echo "test_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          exit $TEST_EXIT
      
      - name: Report coverage metrics
        if: success()
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Shared Utilities" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Plugin Tools (Unit)" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Plugin Tools (Integration)" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Orchestrator Respawn" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Spec Generator" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "**All tests passed** ✓" >> $GITHUB_STEP_SUMMARY
      
      - name: Check test output
        if: failure()
        run: |
          echo "## Test Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests failed. Please review the test output above." >> $GITHUB_STEP_SUMMARY
          exit 1
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.log
          retention-days: 30

  regression-check:
    name: Regression Detection
    runs-on: ubuntu-latest
    needs: quality
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Bun runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Verify no test regressions
        run: |
          echo "Running regression detection..."
          bun test.ts > /tmp/current-tests.log 2>&1
          
          # Check if all tests passed
          if grep -q "0 fail" /tmp/current-tests.log; then
            echo "✓ No regressions detected - all tests passing"
            exit 0
          else
            echo "✗ Regression detected - some tests are failing"
            cat /tmp/current-tests.log
            exit 1
          fi
